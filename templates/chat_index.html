<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medical Chatbot</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />

  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    rel="stylesheet"
  />

  <!-- Your stylesheet (Flask) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>
</head>

<body class="chatbody">
  <div class="chatbot-container min-vh-100 d-flex align-items-center justify-content-center">
    <div class="chat-card card shadow-lg border-0">
      <!-- Header -->
      <div class="card-header d-flex align-items-center gap-3 border-0">
        <div class="avatar-wrap position-relative">
          <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle avatar" alt="Bot avatar"/>
          <span class="status-dot bg-success border border-2 border-white rounded-circle"></span>
        </div>
        <div class="flex-grow-1">
          <h1 class="h5 mb-0 text-white">Medical Chatbot</h1>
          <small class="text-white-50">Ask me anything</small>
        </div>
        <button class="btn btn-sm btn-outline-light" id="clearChatBtn" title="Clear chat">
          <i class="bi bi-trash3"></i>
        </button>
      </div>

      <!-- Messages -->
      <div id="messages" class="card-body pt-3 pb-0 overflow-auto" aria-live="polite"></div>

      <!-- Footer / Input -->
      <div class="card-footer border-0">
        <form id="messageForm" class="d-flex align-items-end gap-2">
          <div class="form-floating flex-grow-1">
            <textarea
              id="text"
              class="form-control chat-input"
              placeholder="Type your message…"
              style="height: 60px"
              required
            ></textarea>
            <label for="text">Type your message…</label>
          </div>

          <button id="sendBtn" type="submit" class="btn btn-brand d-flex align-items-center gap-2">
            <span class="send-label"><i class="bi bi-send-fill"></i> Send</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </form>
        <div class="mt-2 small text-white-50">Press <kbd>Enter</kbd> to send • <kbd>Shift</kbd>+<kbd>Enter</kbd> for a new line</div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (no jQuery) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <script>
    // ---------- Helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const messagesEl = $("#messages");
    const form = $("#messageForm");
    const input = $("#text");
    const sendBtn = $("#sendBtn");
    const clearBtn = $("#clearChatBtn");

    const escapeHtml = (s) =>
      s.replace(/[&<>"']/g, (m) => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[m]));

    const timeNow = () =>
      new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

    const scrollToBottom = () => {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    };

    // ---------- Typing indicator ----------
    let typingNode = null;
    const showTyping = () => {
      if (typingNode) return;
      typingNode = document.createElement("div");
      typingNode.className = "d-flex align-items-end gap-2 mb-3";
      typingNode.innerHTML = `
        <div class="avatar-sm">
          <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle avatar-sm-img" alt="Bot"/>
        </div>
        <div class="bubble bot typing">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
      `;
      messagesEl.appendChild(typingNode);
      scrollToBottom();
    };
    const hideTyping = () => {
      if (typingNode) {
        typingNode.remove();
        typingNode = null;
      }
    };

    // ---------- Rendering ----------
    const renderUser = (text) => {
      const node = document.createElement("div");
      node.className = "d-flex justify-content-end align-items-end gap-2 mb-3";
      node.innerHTML = `
        <div class="bubble user">
          ${escapeHtml(text)}
          <span class="timestamp">${timeNow()}</span>
        </div>
        <div class="avatar-sm">
          <img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle avatar-sm-img" alt="You"/>
        </div>
      `;
      messagesEl.appendChild(node);
      scrollToBottom();
    };

    const renderBot = (html) => {
      const node = document.createElement("div");
      node.className = "d-flex align-items-end gap-2 mb-3";
      node.innerHTML = `
        <div class="avatar-sm">
          <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle avatar-sm-img" alt="Bot"/>
        </div>
        <div class="bubble bot">
          ${html}
          <span class="timestamp">${timeNow()}</span>
        </div>
      `;
      messagesEl.appendChild(node);
      scrollToBottom();
    };

    const renderError = (msg) => {
      const node = document.createElement("div");
      node.className = "d-flex align-items-end gap-2 mb-3";
      node.innerHTML = `
        <div class="avatar-sm">
          <i class="bi bi-exclamation-triangle-fill text-warning fs-5"></i>
        </div>
        <div class="bubble error">
          ${escapeHtml(msg)}
          <span class="timestamp">${timeNow()}</span>
        </div>
      `;
      messagesEl.appendChild(node);
      scrollToBottom();
    };

    // ---------- UX: Enter to send ----------
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    // ---------- Clear chat ----------
    clearBtn.addEventListener("click", () => {
      messagesEl.innerHTML = "";
      input.focus();
    });

    // ---------- Submit ----------
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const rawText = input.value.trim();
      if (!rawText) return;

      renderUser(rawText);
      input.value = "";
      input.style.height = "60px";

      // disable send
      sendBtn.disabled = true;
      sendBtn.querySelector(".send-label").classList.add("d-none");
      sendBtn.querySelector(".spinner-border").classList.remove("d-none");

      showTyping();
      try {
        // Flask endpoint expecting form-encoded "msg"
        const body = new URLSearchParams({ msg: rawText });
        const resp = await fetch("/get", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body
        });

        const data = await resp.text(); // backend returns plain text
        hideTyping();
        renderBot(data);
      } catch (err) {
        hideTyping();
        renderError("Something went wrong. Please try again.");
        console.error(err);
      } finally {
        // re-enable send
        sendBtn.disabled = false;
        sendBtn.querySelector(".send-label").classList.remove("d-none");
        sendBtn.querySelector(".spinner-border").classList.add("d-none");
        input.focus();
      }
    });
  </script>
</body>
</html>
